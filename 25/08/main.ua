Input ← &fras "input.txt"

Parse ← ↯∞_3⊜⋕¬⊸∊"\n,"

Part₁ ← (
  ⊏↙1e3⍏⍜°√/+/-⍉∩⧅₂<°˜⊏
  ◌⍢(
    ⍥(⊂⟜(∩⌟▽⟜¬/+⍉⊸∊♭))∞ ⊃↙↘1
    ⊃⋅∘(˜⊂⧻◴♭⊙⋅∘)
  | ±⧻
  ) ⊙[]
  /×⊏↙3⊸⍖
)

Mask    ← ⬚0↙1e3°⊚
Connect ← ⨬(⋅⊂|⊂⊙(↥/↥)∩⌟▽⊸¬) ⤚⊸(⊸⬚0/↥≡/↥×¤)

Part₂ ← (
  ⊏⍏/+°√/-⍉∩⧅₂<⟜⊃(⇡⧻)≡⊢
  ⊙(↯0_1000[])
  ⍢(⊃(⊓+₁∘|Connect Mask⊏)|¬/×⬚0⊢ ◌◌) 0
  /×⊏⊙◌⊏-₁
)

Connect ← ˜⊂□◴⍆⊂⟜(/◇⊂∩⌟▽⟜¬⊸≡⌞◇(/↥∊))

Part₂ ← (
  ⊏⍖⍜°√/+/-⍉∩⧅₂<⟜⊃(⇡⧻)≡⊢
  /×⊏⊓⊣⋅∘⍢(⟜(Connect⊣)↘₋₁|≠1000◇⧻⬚[]⊢◌)˜⊂0 ⊙{}
)

⍜now(⊃Part₁ Part₂ Parse) Input
